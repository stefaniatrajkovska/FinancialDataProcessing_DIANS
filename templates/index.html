
<!DOCTYPE html>
<html>
<head>
    <title>Real-time Stock Data</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.7.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        h1 {
            color: #333;
            text-align: center;
        }
        .status {
            text-align: center;
            padding: 10px;
            margin-bottom: 20px;
            background-color: #e8f5e9;
            border-radius: 5px;
            font-weight: bold;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        .stock-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        .stock-card {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            padding: 15px;
            transition: transform 0.3s ease;
        }
        .stock-card:hover {
            transform: translateY(-5px);
        }
        .stock-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        .stock-symbol {
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }
        .stock-date {
            color: #666;
        }
        .stock-price {
            font-size: 32px;
            font-weight: bold;
            margin: 15px 0;
        }
        .stock-data {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        .data-item {
            display: flex;
            flex-direction: column;
        }
        .data-label {
            font-size: 12px;
            color: #666;
        }
        .data-value {
            font-size: 16px;
            font-weight: bold;
        }
        .chart-container {
            margin-top: 20px;
            height: 300px;
        }
        .positive {
            color: #4caf50;
        }
        .negative {
            color: #f44336;
        }
        .neutral {
            color: #333;
        }
        .chart-controls {
            display: flex;
            justify-content: center;
            margin-top: 10px;
            gap: 10px;
        }
        button {
            padding: 8px 16px;
            background-color: #4caf50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background-color: #45a049;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Real-time Stock Data</h1>
        <div id="status" class="status">Waiting for data...</div>
        <div class="chart-container">
            <canvas id="priceChart"></canvas>
        </div>
        <div class="chart-controls">
            <button id="toggleAnimation">Toggle Animation</button>
            <button id="clearData">Clear All Data</button>
        </div>
        <div class="stock-grid" id="stockGrid">
            <!-- Stock cards will be dynamically added here -->
        </div>
    </div>

    <script>
        // Connect to the Socket.IO server
        const socket = io();

        // Store stock data
        const stockData = {};
        let dataReceived = false;
        let animationEnabled = true;
        let messageCount = 0;

        // Status indicator
        const statusElement = document.getElementById('status');

        // Create a price chart
        const ctx = document.getElementById('priceChart').getContext('2d');
        const priceChart = new Chart(ctx, {
            type: 'line',
            data: {
                datasets: []
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    x: {
                        type: 'time',
                        time: {
                            unit: 'minute',
                            displayFormats: {
                                minute: 'HH:mm:ss'
                            }
                        },
                        title: {
                            display: true,
                            text: 'Time'
                        }
                    },
                    y: {
                        beginAtZero: false,
                        title: {
                            display: true,
                            text: 'Price ($)'
                        }
                    }
                },
                plugins: {
                    legend: {
                        position: 'top',
                    },
                    title: {
                        display: true,
                        text: 'Stock Price Trends'
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false
                    }
                },
                animation: {
                    duration: 0
                },
                hover: {
                    mode: 'nearest',
                    intersect: true
                }
            }
        });

        // Chart datasets map
        const chartDatasets = {};

        // Event listeners for buttons
        document.getElementById('toggleAnimation').addEventListener('click', function() {
            animationEnabled = !animationEnabled;
            priceChart.options.animation.duration = animationEnabled ? 1000 : 0;
            this.textContent = animationEnabled ? 'Disable Animation' : 'Enable Animation';
        });

        document.getElementById('clearData').addEventListener('click', function() {
            Object.keys(chartDatasets).forEach(symbol => {
                chartDatasets[symbol].data = [];
            });
            priceChart.update();
            console.log('Chart data cleared');
        });

        // Handle initial data
        socket.on('initial_data', (data) => {
            console.log('Received initial data:', data.length, 'items');
            data.forEach(stock => {
                updateStockData(stock);
            });
            dataReceived = true;
            updateStatus();
        });

        // Handle stock updates
        socket.on('stock_update', (data) => {
            messageCount++;
            if (messageCount % 10 === 0) {
                console.log(`Processed ${messageCount} updates`);
            }
            updateStockData(data);
            dataReceived = true;
            updateStatus();
        });

        function updateStatus() {
            if (dataReceived) {
                statusElement.textContent = `Live data streaming... (${Object.keys(stockData).length} symbols)`;
                statusElement.style.backgroundColor = "#e8f5e9";
            } else {
                statusElement.textContent = "Waiting for data...";
                statusElement.style.backgroundColor = "#ffebee";
            }
        }

        function updateStockData(stock) {
            const symbol = stock.Symbol;
            stockData[symbol] = stock;

            // Update or create chart dataset
            if (!chartDatasets[symbol]) {
                const color = getRandomColor();
                chartDatasets[symbol] = {
                    label: symbol,
                    data: [],
                    borderColor: color,
                    backgroundColor: color + '20',
                    borderWidth: 2,
                    tension: 0.2,
                    fill: false
                };
                priceChart.data.datasets.push(chartDatasets[symbol]);
            }

            // Add data point to chart
            chartDatasets[symbol].data.push({
                x: new Date(stock.Date),
                y: stock.Close
            });

            // Keep only last 100 points
            if (chartDatasets[symbol].data.length > 100) {
                chartDatasets[symbol].data.shift();
            }

            // Update chart
            priceChart.update();

            // Update UI
            updateStockGrid();
        }

        function updateStockGrid() {
            const stockGrid = document.getElementById('stockGrid');
            stockGrid.innerHTML = '';

            Object.values(stockData).forEach(stock => {
                const card = document.createElement('div');
                card.className = 'stock-card';

                const priceChange = stock.Close - stock.Open;
                const priceChangePercent = (priceChange / stock.Open) * 100;
                const priceChangeClass = priceChange > 0 ? 'positive' : priceChange < 0 ? 'negative' : 'neutral';

                card.innerHTML = `
                    <div class="stock-header">
                        <span class="stock-symbol">${stock.Symbol}</span>
                        <span class="stock-date">${formatDate(stock.Date)}</span>
                    </div>
                    <div class="stock-price ${priceChangeClass}">$${stock.Close.toFixed(2)}</div>
                    <div class="stock-data">
                        <div class="data-item">
                            <span class="data-label">Open</span>
                            <span class="data-value">$${stock.Open.toFixed(2)}</span>
                        </div>
                        <div class="data-item">
                            <span class="data-label">High</span>
                            <span class="data-value">$${stock.High.toFixed(2)}</span>
                        </div>
                        <div class="data-item">
                            <span class="data-label">Low</span>
                            <span class="data-value">$${stock.Low.toFixed(2)}</span>
                        </div>
                        <div class="data-item">
                            <span class="data-label">Volume</span>
                            <span class="data-value">${formatNumber(stock.Volume)}</span>
                        </div>
                    </div>
                    <div class="data-item" style="margin-top: 10px;">
                        <span class="data-label">Change</span>
                        <span class="data-value ${priceChangeClass}">
                            ${priceChange > 0 ? '+' : ''}${priceChange.toFixed(2)} (${priceChangePercent.toFixed(2)}%)
                        </span>
                    </div>
                `;

                stockGrid.appendChild(card);
            });
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
        }

        function formatNumber(num) {
            return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }

        function getRandomColor() {
            const letters = '0123456789ABCDEF';
            let color = '#';
            for (let i = 0; i < 6; i++) {
                color += letters[Math.floor(Math.random() * 16)];
            }
            return color;
        }
    </script>
</body>
</html>
        